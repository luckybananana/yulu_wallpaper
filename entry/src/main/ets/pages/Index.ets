import { promptAction, router } from '@kit.ArkUI';
import { QuoteDataManager, Quote } from '../common/QuoteDataManager';

// ToastÈÄâÈ°πÊé•Âè£
interface ShowToastOptions {
  message: string;
  duration?: number;
}

@Entry
@Component
struct Index {
  @State quotes: Quote[] = [];
  @State isMultiSelectMode: boolean = false;
  @State selectedQuotes: Set<string> = new Set();
  @State isLoading: boolean = true;
  @State showActionMenu: boolean = false;
  @State currentQuote: Quote | null = null;
  @State isSearchMode: boolean = false;
  @State searchKeyword: string = '';
  @State filteredQuotes: Quote[] = [];
  
  private dataManager: QuoteDataManager = QuoteDataManager.getInstance(getContext(this));

  async aboutToAppear() {
    await this.loadData();
  }

  // È°µÈù¢ÊòæÁ§∫Êó∂Âà∑Êñ∞Êï∞ÊçÆ
  async onPageShow() {
    await this.loadData();
  }

  async loadData() {
    try {
      this.isLoading = true;
      await this.dataManager.initialize();
      this.quotes = await this.dataManager.getAllQuotes();
    } catch (error) {
      console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
      const loadErrorToast: ShowToastOptions = {
        message: 'Âä†ËΩΩËØ≠ÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï'
      };
      promptAction.showToast(loadErrorToast);
    } finally {
      this.isLoading = false;
    }
  }

  // ÊòæÁ§∫Êìç‰ΩúËèúÂçï
  showQuoteActionMenu(quote: Quote) {
    if (this.isMultiSelectMode) {
      this.toggleQuoteSelection(quote.id);
      return;
    }
    this.currentQuote = quote;
    this.showActionMenu = true;
  }

  // ÈöêËóèÊìç‰ΩúËèúÂçï
  hideQuoteActionMenu() {
    this.showActionMenu = false;
    this.currentQuote = null;
  }

  // ÂàáÊç¢ËØ≠ÂΩïÈÄâÊã©Áä∂ÊÄÅ
  toggleQuoteSelection(quoteId: string) {
    if (!this.isMultiSelectMode) {
      this.enterMultiSelectMode();
    }

    if (this.selectedQuotes.has(quoteId)) {
      this.selectedQuotes.delete(quoteId);
    } else {
      this.selectedQuotes.add(quoteId);
    }

    // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰ΩïÈ°πÔºåÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
    if (this.selectedQuotes.size === 0) {
      this.exitMultiSelectMode();
    }
  }

  // ËøõÂÖ•Â§öÈÄâÊ®°Âºè
  enterMultiSelectMode() {
    this.isMultiSelectMode = true;
  }

  // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
  exitMultiSelectMode() {
    this.isMultiSelectMode = false;
    this.selectedQuotes.clear();
  }

  // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
  toggleSelectAll() {
    const currentQuotes = this.getCurrentQuotes();
    const allSelected = this.selectedQuotes.size === currentQuotes.length;
    
    if (allSelected) {
      this.selectedQuotes.clear();
      this.exitMultiSelectMode();
    } else {
      this.selectedQuotes.clear();
      currentQuotes.forEach(quote => this.selectedQuotes.add(quote.id));
    }
  }

  // Âà†Èô§ÈÄâ‰∏≠ÁöÑËØ≠ÂΩï
  async deleteSelectedQuotes() {
    if (this.selectedQuotes.size === 0) return;

    try {
      const ids = Array.from(this.selectedQuotes);
      const deletedCount = await this.dataManager.deleteQuotes(ids);
      const deleteSuccessToast: ShowToastOptions = {
        message: 'Âà†Èô§ÊàêÂäü'
      };
      promptAction.showToast(deleteSuccessToast);
      
      this.exitMultiSelectMode();
      await this.loadData();
    } catch (error) {
      console.error('Âà†Èô§ËØ≠ÂΩïÂ§±Ë¥•:', error);
      const deleteErrorToast: ShowToastOptions = {
        message: 'Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
      };
      promptAction.showToast(deleteErrorToast);
    }
  }

  // Êñ∞Â¢ûËØ≠ÂΩï
  addQuote() {
    this.hideQuoteActionMenu();
    router.pushUrl({
      url: 'pages/EditPage'
    });
  }

  // ÁºñËæëËØ≠ÂΩï
  editQuote() {
    this.hideQuoteActionMenu();
    if (this.currentQuote) {
      router.pushUrl({
        url: 'pages/EditPage',
        params: { quote: JSON.stringify(this.currentQuote), mode: 'edit' }
      }).catch((error: Error) => {
        console.error('Ë∑≥ËΩ¨ÁºñËæëÈ°µÈù¢Â§±Ë¥•:', error);
        const errorToast: ShowToastOptions = {
          message: 'Ë∑≥ËΩ¨Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
        };
        promptAction.showToast(errorToast);
      });
    }
  }

  // Âà†Èô§Âçï‰∏™ËØ≠ÂΩï
  async deleteSingleQuote() {
    this.hideQuoteActionMenu();
    if (this.currentQuote) {
      try {
        // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
        promptAction.showDialog({
          title: 'Á°ÆËÆ§Âà†Èô§',
          message: 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØ≠ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ',
          buttons: [
            {
              text: 'ÂèñÊ∂à',
              color: '#666666'
            },
            {
              text: 'Âà†Èô§',
              color: '#FF3B30'
            }
          ]
        }).then(async (result) => {
          if (result.index === 1) { // Áî®Êà∑ÁÇπÂáª‰∫ÜÂà†Èô§
            try {
              await this.dataManager.deleteQuotes([this.currentQuote!.id]);
              const deleteSuccessToast: ShowToastOptions = {
                message: 'Âà†Èô§ÊàêÂäü'
              };
              promptAction.showToast(deleteSuccessToast);
              await this.loadData();
            } catch (error) {
              console.error('Âà†Èô§ËØ≠ÂΩïÂ§±Ë¥•:', error);
              const deleteErrorToast: ShowToastOptions = {
                message: 'Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
              };
              promptAction.showToast(deleteErrorToast);
            }
          }
        }).catch((error: Error) => {
          console.error('ÊòæÁ§∫Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°ÜÂ§±Ë¥•:', error);
        });
      } catch (error) {
        console.error('Âà†Èô§Êìç‰ΩúÂ§±Ë¥•:', error);
        const deleteErrorToast: ShowToastOptions = {
          message: 'Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
        };
        promptAction.showToast(deleteErrorToast);
      }
    }
  }

  // È¢ÑËßàÂ£ÅÁ∫∏
  previewWallpaper() {
    this.hideQuoteActionMenu();
    if (this.currentQuote) {
      router.pushUrl({
        url: 'pages/WallpaperPage',
        params: { quote: JSON.stringify(this.currentQuote) }
      }).catch((error: Error) => {
        console.error('Ë∑≥ËΩ¨Â£ÅÁ∫∏È¢ÑËßàÈ°µÈù¢Â§±Ë¥•:', error);
        const errorToast: ShowToastOptions = {
          message: 'Ë∑≥ËΩ¨Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
        };
        promptAction.showToast(errorToast);
      });
    }
  }

  // ÊâìÂºÄËÆæÁΩÆ
  openSettings() {
    router.pushUrl({
      url: 'pages/SettingsPage'
    });
  }

  // ÊâìÂºÄÂØºÂÖ•ÂØºÂá∫
  openImportExport() {
    router.pushUrl({
      url: 'pages/ImportExportPage'
    });
  }

  // ÂàáÊç¢ÊêúÁ¥¢Ê®°Âºè
  toggleSearchMode() {
    this.isSearchMode = !this.isSearchMode;
    if (!this.isSearchMode) {
      this.searchKeyword = '';
      this.filteredQuotes = [];
    }
  }

  // ÊâßË°åÊêúÁ¥¢
  async performSearch() {
    if (this.searchKeyword.trim() === '') {
      this.filteredQuotes = [];
      return;
    }
    
    try {
      this.filteredQuotes = await this.dataManager.searchQuotes(this.searchKeyword);
    } catch (error) {
      console.error('ÊêúÁ¥¢Â§±Ë¥•:', error);
      const searchErrorToast: ShowToastOptions = {
        message: 'ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
      };
      promptAction.showToast(searchErrorToast);
    }
  }

  // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑËØ≠ÂΩïÂàóË°®
  getCurrentQuotes(): Quote[] {
    if (this.isSearchMode && this.searchKeyword.trim() !== '') {
      return this.filteredQuotes;
    }
    return this.quotes;
  }

  build() {
    Stack() {
      Column() {
        // È°∂ÈÉ®ÂØºËà™Ê†èÔºàÊ≠£Â∏∏Ê®°ÂºèÔºâ
        if (!this.isMultiSelectMode) {
          Column() {
            Row() {
              Text('ËØ≠ÂΩïÂ£ÅÁ∫∏')
                .fontSize(20)
                .fontWeight(600)
                .fontColor('#1A1A1A')
                .layoutWeight(1)
              
              Button() {
                Image($r('app.media.ic_search'))
                  .width(20)
                  .height(20)
                  .fillColor('#666666')
              }
              .width(40)
              .height(40)
              .backgroundColor(Color.Transparent)
              .borderRadius(20)
              .onClick(() => {
                this.toggleSearchMode();
              })
            }
            .width('100%')
            .height(56)
            .padding({ left: 16, right: 16 })
            
            // ÊêúÁ¥¢ËæìÂÖ•Ê°Ü
            if (this.isSearchMode) {
              Row() {
                TextInput({ placeholder: 'ÊêúÁ¥¢ËØ≠ÂΩïÂÜÖÂÆπ', text: this.searchKeyword })
                  .layoutWeight(1)
                  .height(40)
                  .borderRadius(20)
                  .backgroundColor('#F5F5F5')
                  .padding({ left: 16, right: 16 })
                  .onChange((value: string) => {
                    this.searchKeyword = value;
                    this.performSearch();
                  })
                
                Button('ÂèñÊ∂à')
                  .fontSize(14)
                  .fontColor('#4A90E2')
                  .backgroundColor(Color.Transparent)
                  .padding({ left: 12, right: 0 })
                  .onClick(() => {
                    this.toggleSearchMode();
                  })
              }
              .width('100%')
              .padding({ left: 16, right: 16, bottom: 12 })
            }
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .border({ width: { bottom: 1 }, color: '#E1E5E9' })
        }

        // Â§öÈÄâÊ®°ÂºèÈ°∂ÈÉ®Ê†è
        if (this.isMultiSelectMode) {
          Row() {
            Row({ space: 16 }) {
              Button() {
                Image($r('app.media.ic_close'))
                  .width(20)
                  .height(20)
                  .fillColor('#FFFFFF')
              }
              .width(40)
              .height(40)
              .backgroundColor(Color.Transparent)
              .onClick(() => this.exitMultiSelectMode())
              
              Text(`Â∑≤ÈÄâÊã© ${this.selectedQuotes.size} Êù°`)
                .fontSize(16)
                .fontWeight(500)
                .fontColor('#FFFFFF')
            }
            .layoutWeight(1)
            
            Row({ space: 16 }) {
              Button() {
                Image($r('app.media.ic_select_all'))
                  .width(20)
                  .height(20)
                  .fillColor('#FFFFFF')
              }
              .width(40)
              .height(40)
              .backgroundColor(Color.Transparent)
              .onClick(() => this.toggleSelectAll())
              
              Button() {
                Image($r('app.media.ic_delete'))
                  .width(20)
                  .height(20)
                  .fillColor('#FFFFFF')
              }
              .width(40)
              .height(40)
              .backgroundColor(Color.Transparent)
              .onClick(() => this.deleteSelectedQuotes())
            }
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor('#4A90E2')
          .justifyContent(FlexAlign.SpaceBetween)
        }

        // ËØ≠ÂΩïÂàóË°®ÂÆπÂô®
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#4A90E2')
              .margin({ bottom: 16 })
            Text('Âä†ËΩΩ‰∏≠...')
              .fontSize(16)
              .fontColor('#666666')
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F8F9FA')
        } else if (this.getCurrentQuotes().length === 0) {
          // Á©∫Áä∂ÊÄÅ
          Column() {
            Text('üí¨')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text(this.isSearchMode && this.searchKeyword.trim() !== '' ? 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËØ≠ÂΩï' : 'ËøòÊ≤°ÊúâËØ≠ÂΩï')
              .fontSize(18)
              .fontColor('#666666')
              .margin({ bottom: 8 })
            Text(this.isSearchMode && this.searchKeyword.trim() !== '' ? 'Â∞ùËØï‰ΩøÁî®ÂÖ∂‰ªñÂÖ≥ÈîÆËØçÊêúÁ¥¢' : 'ÁÇπÂáª‰∏ãÊñπÁöÑ + ÊåâÈíÆ\nÊ∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏ÄÊù°ËØ≠ÂΩïÂêß')
              .fontSize(14)
              .fontColor('#999999')
              .textAlign(TextAlign.Center)
              .lineHeight(20)
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F8F9FA')
        } else {
          // ËØ≠ÂΩïÂàóË°®
          List({ space: 12 }) {
            ForEach(this.getCurrentQuotes(), (quote: Quote) => {
              ListItem() {
                Stack() {
                  // ËØ≠ÂΩïÂç°Áâá
                  Column() {
                    Text(quote.text)
                      .fontSize(16)
                      .fontColor('#1A1A1A')
                      .lineHeight(25.6)
                      .fontWeight(400)
                      .margin({ bottom: 12 })
                      .width('100%')
                    

                  }
                  .width('100%')
                  .padding(20)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(12)
                  .shadow({
                    radius: 3,
                    color: 'rgba(0,0,0,0.12)',
                    offsetX: 0,
                    offsetY: 1
                  })
                  .border({
                    width: this.selectedQuotes.has(quote.id) ? 2 : 0,
                    color: '#4A90E2'
                  })
                  .backgroundColor(this.selectedQuotes.has(quote.id) ? 'rgba(74, 144, 226, 0.05)' : '#FFFFFF')
                  .onClick(() => this.showQuoteActionMenu(quote))
                  .gesture(
                    LongPressGesture({ repeat: false })
                      .onAction(() => {
                        if (!this.isMultiSelectMode) {
                          this.toggleQuoteSelection(quote.id);
                        }
                      })
                  )
                  
                  // Â§öÈÄâÊ®°ÂºèÂ§çÈÄâÊ°Ü
                  if (this.isMultiSelectMode) {
                    Row() {
                      if (this.selectedQuotes.has(quote.id)) {
                        Image($r('app.media.ic_check'))
                          .width(12)
                          .height(12)
                          .fillColor('#FFFFFF')
                      }
                    }
                    .width(20)
                    .height(20)
                    .backgroundColor(this.selectedQuotes.has(quote.id) ? '#4A90E2' : '#FFFFFF')
                    .border({ width: 2, color: '#4A90E2' })
                    .borderRadius(4)
                    .justifyContent(FlexAlign.Center)
                    .position({ x: '100%', y: 0 })
                    .translate({ x: -36, y: 16 })
                  }
                }
              }
            })
          }
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 16 })
          .backgroundColor('#F8F9FA')
          .scrollBar(BarState.Off)
        }

        // Â∫ïÈÉ®Êìç‰ΩúÊ†è
        Row() {
          // ÂØºÂÖ•ÂØºÂá∫ÊåâÈíÆ
          Column({ space: 4 }) {
            Image($r('app.media.ic_import_export'))
              .width(20)
              .height(20)
              .fillColor('#666666')
            Text('ÂØºÂÖ•ÂØºÂá∫')
              .fontSize(12)
              .fontColor('#666666')
          }
          .padding({ top: 8, bottom: 8, left: 12, right: 12 })
          .borderRadius(8)
          .backgroundColor(Color.Transparent)
          .onClick(() => this.openImportExport())
          .layoutWeight(1)
          
          // Êñ∞Â¢ûÊåâÈíÆÔºàFABÊ†∑ÂºèÔºâ
          Button() {
            Image($r('app.media.ic_add'))
              .width(24)
              .height(24)
              .fillColor('#FFFFFF')
          }
          .width(56)
          .height(56)
          .backgroundColor('#4A90E2')
          .borderRadius(28)
          .shadow({
            radius: 6,
            color: 'rgba(0,0,0,0.16)',
            offsetX: 0,
            offsetY: 3
          })
          .onClick(() => this.addQuote())
          
          // ËÆæÁΩÆÊåâÈíÆ
          Column({ space: 4 }) {
            Image($r('app.media.ic_settings'))
              .width(20)
              .height(20)
              .fillColor('#666666')
            Text('ËÆæÁΩÆ')
              .fontSize(12)
              .fontColor('#666666')
          }
          .padding({ top: 8, bottom: 8, left: 12, right: 12 })
          .borderRadius(8)
          .backgroundColor(Color.Transparent)
          .onClick(() => this.openSettings())
          .layoutWeight(1)
        }
        .width('100%')
        .height(80)
        .padding({ left: 20, right: 20 })
        .backgroundColor('#FFFFFF')
        .border({ width: { top: 1 }, color: '#E1E5E9' })
        .justifyContent(FlexAlign.SpaceAround)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F9FA')

      // Êìç‰ΩúËèúÂçïÂºπÁ™ó
      if (this.showActionMenu) {
        Column() {
          // ÈÅÆÁΩ©Â±Ç
          Row()
            .width('100%')
            .layoutWeight(1)
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => this.hideQuoteActionMenu())
          
          // ËèúÂçïÂÜÖÂÆπ
          Column() {
            Row() {
              Text('ÈÄâÊã©Êìç‰Ωú')
                .fontSize(18)
                .fontWeight(600)
                .fontColor('#1A1A1A')
                .layoutWeight(1)
              
              Button() {
                Image($r('app.media.ic_close'))
                  .width(20)
                  .height(20)
                  .fillColor('#666666')
              }
              .width(40)
              .height(40)
              .backgroundColor(Color.Transparent)
              .borderRadius(20)
              .onClick(() => this.hideQuoteActionMenu())
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // Êìç‰ΩúÊåâÈíÆÁΩëÊ†º
            Row({ space: 12 }) {
              // ‰øÆÊîπËØ≠ÂΩï
              Column({ space: 6 }) {
                Image($r('app.media.ic_edit'))
                  .width(20)
                  .height(20)
                  .fillColor('#1A1A1A')
                Text('‰øÆÊîπËØ≠ÂΩï')
                  .fontSize(12)
                  .fontWeight(500)
                  .fontColor('#1A1A1A')
                  .textAlign(TextAlign.Center)
              }
              .width(80)
              .height(80)
              .padding({ top: 16, bottom: 8, left: 8, right: 8 })
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.editQuote())
              .layoutWeight(1)
              
              // Âà†Èô§ËØ≠ÂΩï
              Column({ space: 6 }) {
                Image($r('app.media.ic_delete'))
                  .width(20)
                  .height(20)
                  .fillColor('#FF3B30')
                Text('Âà†Èô§ËØ≠ÂΩï')
                  .fontSize(12)
                  .fontWeight(500)
                  .fontColor('#1A1A1A')
                  .textAlign(TextAlign.Center)
              }
              .width(80)
              .height(80)
              .padding({ top: 16, bottom: 8, left: 8, right: 8 })
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.deleteSingleQuote())
              .layoutWeight(1)
              
              // Â£ÅÁ∫∏È¢ÑËßà
              Column({ space: 6 }) {
                Image($r('app.media.ic_preview'))
                  .width(20)
                  .height(20)
                  .fillColor('#1A1A1A')
                Text('Â£ÅÁ∫∏È¢ÑËßà')
                  .fontSize(12)
                  .fontWeight(500)
                  .fontColor('#1A1A1A')
                  .textAlign(TextAlign.Center)
              }
              .width(80)
              .height(80)
              .padding({ top: 16, bottom: 8, left: 8, right: 8 })
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.previewWallpaper())
              .layoutWeight(1)
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius({ topLeft: 16, topRight: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.End)
      }
    }
    .width('100%')
    .height('100%')
  }
}