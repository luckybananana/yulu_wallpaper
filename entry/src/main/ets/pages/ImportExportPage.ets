import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { QuoteDataManager, Quote, AddQuoteParams } from '../common/QuoteDataManager';
import { fileIo } from '@kit.CoreFileKit';

/**
 * å¯¼å…¥æ•°æ®æ¥å£
 */
interface ImportData {
  quotes?: Quote[];
}

// æ·»åŠ è¯­å½•æ•°æ®æ¥å£ - ä¸QuoteDataManagerä¿æŒä¸€è‡´
// interface AddQuoteParams {
//   text: string;
//   author: string;
//   category: string;
//   tags: string[];
// }

// å¯¹è¯æ¡†æŒ‰é’®æ¥å£
interface DialogButton {
  text: string;
  color: string;
}

// Toasté€‰é¡¹æ¥å£
interface ShowToastOptions {
  message: string;
  duration?: number;
}



/**
 * å¯¼å‡ºæ•°æ®æ¥å£
 */
interface ExportData {
  version: string;
  exportTime: string;
  totalCount: number;
  quotes: Quote[];
}

/**
 * å¯¼å…¥å¯¼å‡ºé¡µé¢
 * åŸºäºimport-export.htmlå®ç°æ•°æ®ç®¡ç†åŠŸèƒ½
 * æ”¯æŒè¯­å½•æ•°æ®çš„å¯¼å…¥ã€å¯¼å‡ºã€å¤‡ä»½å’Œæ¢å¤
 */
@Entry
@Component
struct ImportExportPage {
  // é¡µé¢çŠ¶æ€
  @State quotes: Quote[] = [];
  @State isLoading: boolean = false;
  @State selectedFile: string = '';
  @State importPreview: Quote[] = [];
  @State showPreview: boolean = false;
  
  // ç»Ÿè®¡ä¿¡æ¯
  @State totalQuotes: number = 0;
  @State categoryCounts: Map<string, number> = new Map();
  
  // æœåŠ¡å®ä¾‹
  private quoteManager = QuoteDataManager.getInstance(getContext(this));

  /**
   * é¡µé¢åˆå§‹åŒ–
   */
  async aboutToAppear() {
    await this.loadStatistics();
  }

  /**
   * åŠ è½½ç»Ÿè®¡ä¿¡æ¯
   */
  async loadStatistics() {
    try {
      this.quotes = await this.quoteManager.getAllQuotes();
      this.totalQuotes = this.quotes.length;
      
      // ç»Ÿè®¡åˆ†ç±»æ•°é‡
      this.categoryCounts.clear();
      this.quotes.forEach(quote => {
        const category = quote.category || 'æœªåˆ†ç±»';
        const count = this.categoryCounts.get(category) || 0;
        this.categoryCounts.set(category, count + 1);
      });
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  /**
   * å¯¼å‡ºæ•°æ®åˆ°JSONæ–‡ä»¶
   */
  async exportData() {
    if (this.quotes.length === 0) {
      const noDataToast: ShowToastOptions = {
      message: 'æš‚æ— æ•°æ®å¯å¯¼å‡º'
    };
      noDataToast.duration = 2000;
      promptAction.showToast(noDataToast);
      return;
    }

    this.isLoading = true;
    try {
      const exportData: ExportData = {
        version: '1.0',
        exportTime: new Date().toISOString(),
        totalCount: this.quotes.length,
        quotes: this.quotes
      };
      
      const jsonString = JSON.stringify(exportData, null, 2);
      const fileName = `è¯­å½•å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
      
      // TODO: å®ç°æ–‡ä»¶ä¿å­˜åŠŸèƒ½
      // è¿™é‡Œéœ€è¦ä½¿ç”¨HarmonyOSçš„æ–‡ä»¶ä¿å­˜API
      
      const exportSuccessToast: ShowToastOptions = {
         message: `æˆåŠŸå¯¼å‡º${this.quotes.length}æ¡è¯­å½•`
       };
      exportSuccessToast.duration = 2000;
      promptAction.showToast(exportSuccessToast);
    } catch (error) {
      console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
      const exportErrorToast: ShowToastOptions = {
        message: 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•'
      };
      exportErrorToast.duration = 2000;
      promptAction.showToast(exportErrorToast);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * é€‰æ‹©å¯¼å…¥æ–‡ä»¶
   */
  async selectImportFile() {
    try {
      const documentSelectOptions = new picker.DocumentSelectOptions();
      documentSelectOptions.maxSelectNumber = 1;
      documentSelectOptions.fileSuffixFilters = ['.json', '.txt'];
      
      const documentViewPicker = new picker.DocumentViewPicker();
      const result = await documentViewPicker.select(documentSelectOptions);
      
      if (result && result.length > 0) {
        this.selectedFile = result[0];
        await this.previewImportData();
      }
    } catch (error) {
      console.error('é€‰æ‹©æ–‡ä»¶å¤±è´¥:', error);
      const selectFileErrorToast: ShowToastOptions = {
         message: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥'
       };
      selectFileErrorToast.duration = 2000;
      promptAction.showToast(selectFileErrorToast);
    }
  }

  /**
   * é¢„è§ˆå¯¼å…¥æ•°æ®
   */
  async previewImportData() {
    if (!this.selectedFile) return;

    this.isLoading = true;
    try {
      const file = fileIo.openSync(this.selectedFile, fileIo.OpenMode.READ_ONLY);
      const buffer = new ArrayBuffer(1024 * 1024); // 1MB buffer
      const readLen = fileIo.readSync(file.fd, buffer);
      fileIo.closeSync(file.fd);
      
      const uint8Array = new Uint8Array(buffer, 0, readLen);
      let content = '';
      for (let i = 0; i < uint8Array.length; i++) {
        content += String.fromCharCode(uint8Array[i]);
      }
      const importData: ImportData = JSON.parse(content);
      
      if (importData.quotes && Array.isArray(importData.quotes)) {
        this.importPreview = importData.quotes.slice(0, 10); // é¢„è§ˆå‰10æ¡
        this.showPreview = true;
      } else {
        throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
      }
    } catch (error) {
      console.error('é¢„è§ˆå¯¼å…¥æ•°æ®å¤±è´¥:', error);
      const previewErrorToast: ShowToastOptions = {
          message: 'æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„JSONæ–‡ä»¶'
        };
      previewErrorToast.duration = 2000;
      promptAction.showToast(previewErrorToast);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * ç¡®è®¤å¯¼å…¥æ•°æ®
   */
  async confirmImport() {
    if (!this.selectedFile) return;

    this.isLoading = true;
    try {
      const file = fileIo.openSync(this.selectedFile, fileIo.OpenMode.READ_ONLY);
      const buffer = new ArrayBuffer(1024 * 1024);
      const readLen = fileIo.readSync(file.fd, buffer);
      fileIo.closeSync(file.fd);
      
      const uint8Array2 = new Uint8Array(buffer, 0, readLen);
      let content2 = '';
      for (let i = 0; i < uint8Array2.length; i++) {
        content2 += String.fromCharCode(uint8Array2[i]);
      }
      const importData2: ImportData = JSON.parse(content2);
      
      if (importData2.quotes && Array.isArray(importData2.quotes)) {
        let importCount = 0;
        for (const quote of importData2.quotes) {
          if (quote.text && quote.text.trim()) {
            const addQuoteData: AddQuoteParams = {
              text: quote.text,
              author: quote.author || 'æœªçŸ¥',
              category: quote.category || 'é»˜è®¤',
              tags: quote.tags || []
            };
            await this.quoteManager.addQuote(addQuoteData);
            importCount++;
          }
        }
        
        await this.loadStatistics();
        this.showPreview = false;
        this.selectedFile = '';
        
        const successToast: ShowToastOptions = {
          message: `æˆåŠŸå¯¼å…¥${importCount}æ¡è¯­å½•`
        };
        promptAction.showToast(successToast);
      }
    } catch (error) {
      console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
      const errorToast: ShowToastOptions = {} as ShowToastOptions;
      errorToast.message = 'å¯¼å…¥å¤±è´¥';
      errorToast.duration = 2000;
      promptAction.showToast(errorToast);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰æ•°æ®
   */
  async clearAllData() {
    promptAction.showDialog({
      title: 'ç¡®è®¤æ¸…ç©º',
      message: `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${this.totalQuotes}æ¡è¯­å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: '#666666'
        },
        {
          text: 'ç¡®è®¤æ¸…ç©º',
          color: '#FF3B30'
        }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        try {
          await this.quoteManager.clearAllQuotes();
          await this.loadStatistics();
          
          const clearSuccessToast: ShowToastOptions = {} as ShowToastOptions;
          clearSuccessToast.message = 'å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®';
          clearSuccessToast.duration = 2000;
          promptAction.showToast(clearSuccessToast);
        } catch (error) {
          console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
          const clearErrorToast: ShowToastOptions = {} as ShowToastOptions;
          clearErrorToast.message = 'æ¸…ç©ºå¤±è´¥';
          clearErrorToast.duration = 2000;
          promptAction.showToast(clearErrorToast);
        }
      }
    });
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack() {
    router.back();
  }

  /**
   * æ„å»ºé¡µé¢UI
   */
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333333')
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())
        
        Text('æ•°æ®ç®¡ç†')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button() {
          Text('å¸®åŠ©')
            .fontSize(16)
            .fontColor('#007AFF')
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          promptAction.showDialog({
            title: 'ä½¿ç”¨è¯´æ˜',
            message: 'â€¢ å¯¼å‡ºï¼šå°†å½“å‰æ‰€æœ‰è¯­å½•ä¿å­˜ä¸ºJSONæ–‡ä»¶\nâ€¢ å¯¼å…¥ï¼šä»JSONæ–‡ä»¶ä¸­å¯¼å…¥è¯­å½•æ•°æ®\nâ€¢ æ¸…ç©ºï¼šåˆ é™¤æ‰€æœ‰æœ¬åœ°è¯­å½•æ•°æ®\n\næ³¨æ„ï¼šå¯¼å…¥ä¼šè¿½åŠ æ•°æ®ï¼Œä¸ä¼šè¦†ç›–ç°æœ‰æ•°æ®',
            buttons: [{
              text: 'çŸ¥é“äº†',
              color: '#007AFF'
            }]
          });
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#E5E5E5' })

      Scroll() {
        Column() {
          // æ•°æ®ç»Ÿè®¡å¡ç‰‡
          Column() {
            Row() {
              Text('æ•°æ®ç»Ÿè®¡')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
              
              Blank()
              
              Text('ğŸ“Š')
                .fontSize(20)
            }
            .width('100%')
            .margin({ bottom: 16 })

            Row() {
              Column() {
                Text(`${this.totalQuotes}`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#007AFF')
                
                Text('æ€»è¯­å½•æ•°')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              
              Column() {
                Text(`${this.categoryCounts.size}`)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#34C759')
                
                Text('åˆ†ç±»æ•°')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              
              Column() {
                Text(this.totalQuotes > 0 ? new Date().toLocaleDateString() : '--')
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#FF9500')
                
                Text('æœ€åæ›´æ–°')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })

          // å¯¼å‡ºåŠŸèƒ½å¡ç‰‡
          Column() {
            Row() {
              Column() {
                Text('å¯¼å‡ºæ•°æ®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                
                Text('å°†æ‰€æœ‰è¯­å½•å¯¼å‡ºä¸ºJSONæ–‡ä»¶')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Text('ğŸ“¤')
                .fontSize(24)
            }
            .width('100%')
            .margin({ bottom: 16 })

            Button('å¯¼å‡ºæ•°æ®')
              .width('100%')
              .height(44)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .borderRadius(8)
              .enabled(!this.isLoading && this.totalQuotes > 0)
              .onClick(() => this.exportData())
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })

          // å¯¼å…¥åŠŸèƒ½å¡ç‰‡
          Column() {
            Row() {
              Column() {
                Text('å¯¼å…¥æ•°æ®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                
                Text('ä»JSONæ–‡ä»¶å¯¼å…¥è¯­å½•æ•°æ®')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Text('ğŸ“¥')
                .fontSize(24)
            }
            .width('100%')
            .margin({ bottom: 16 })

            if (this.selectedFile) {
              Column() {
                Text('å·²é€‰æ‹©æ–‡ä»¶')
                  .fontSize(12)
                  .fontColor('#666666')
                  .alignSelf(ItemAlign.Start)
                
                Text(this.selectedFile.split('/').pop() || '')
                  .fontSize(14)
                  .fontColor('#333333')
                  .margin({ top: 4 })
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#F8F9FA')
              .borderRadius(8)
              .margin({ bottom: 12 })
            }

            Row() {
              Button('é€‰æ‹©æ–‡ä»¶')
                .layoutWeight(1)
                .height(44)
                .fontSize(16)
                .fontColor('#007AFF')
                .backgroundColor('#F0F8FF')
                .borderRadius(8)
                .enabled(!this.isLoading)
                .onClick(() => this.selectImportFile())
              
              if (this.selectedFile) {
                Button('å¼€å§‹å¯¼å…¥')
                  .layoutWeight(1)
                  .height(44)
                  .fontSize(16)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#34C759')
                  .borderRadius(8)
                  .margin({ left: 12 })
                  .enabled(!this.isLoading)
                  .onClick(() => this.confirmImport())
              }
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })

          // å¯¼å…¥é¢„è§ˆ
          if (this.showPreview && this.importPreview.length > 0) {
            Column() {
              Row() {
                Text('å¯¼å…¥é¢„è§ˆ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                
                Blank()
                
                Text(`${this.importPreview.length}æ¡`)
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .width('100%')
              .margin({ bottom: 12 })

              ForEach(this.importPreview.slice(0, 3), (quote: Quote, index: number) => {
                Column() {
                  Text(quote.text || '')
                    .fontSize(14)
                    .fontColor('#333333')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                  
                  if (quote.author) {
                    Text(`â€”â€” ${quote.author}`)
                      .fontSize(12)
                      .fontColor('#666666')
                      .margin({ top: 4 })
                      .alignSelf(ItemAlign.End)
                  }
                }
                .width('100%')
                .padding(12)
                .backgroundColor('#F8F9FA')
                .borderRadius(8)
                .margin({ bottom: 8 })
              })

              if (this.importPreview.length > 3) {
                Text(`è¿˜æœ‰${this.importPreview.length - 3}æ¡è¯­å½•...`)
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 8 })
              }
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ bottom: 16 })
          }

          // å±é™©æ“ä½œåŒºåŸŸ
          Column() {
            Row() {
              Column() {
                Text('æ¸…ç©ºæ•°æ®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#FF3B30')
                
                Text('åˆ é™¤æ‰€æœ‰æœ¬åœ°è¯­å½•æ•°æ®')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Text('âš ï¸')
                .fontSize(24)
            }
            .width('100%')
            .margin({ bottom: 16 })

            Button('æ¸…ç©ºæ‰€æœ‰æ•°æ®')
              .width('100%')
              .height(44)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#FF3B30')
              .borderRadius(8)
              .enabled(!this.isLoading && this.totalQuotes > 0)
              .onClick(() => this.clearAllData())
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Row() {
          LoadingProgress()
            .width(20)
            .height(20)
            .color('#007AFF')
          
          Text('å¤„ç†ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 8 })
        }
        .width('100%')
        .height(50)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('rgba(255, 255, 255, 0.9)')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}