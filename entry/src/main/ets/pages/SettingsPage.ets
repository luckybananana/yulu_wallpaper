import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { bundleManager } from '@kit.AbilityKit';

/**
 * å­—ä½“å¤§å°é€‰é¡¹æ¥å£
 */
interface FontSizeOption {
  label: string;
  value: number;
}

/**
 * å¯¹è¯æ¡†æŒ‰é’®æ¥å£
 */
interface DialogButton {
  text: string;
  color: string;
}

/**
 * Toasté€‰é¡¹æ¥å£
 */
interface ShowToastOptions {
  message: string;
  duration?: number;
}

/**
 * è®¾ç½®é¡µé¢
 * åŸºäºsettings.htmlå®ç°åº”ç”¨è®¾ç½®åŠŸèƒ½
 * åŒ…å«ä¸»é¢˜è®¾ç½®ã€å­—ä½“è®¾ç½®ã€æ•°æ®ç®¡ç†ã€å…³äºåº”ç”¨ç­‰åŠŸèƒ½
 */
@Entry
@Component
struct SettingsPage {
  // è®¾ç½®é¡¹çŠ¶æ€
  @State autoBackup: boolean = true;
  @State notificationEnabled: boolean = true;
  @State appVersion: string = '1.0.0';
  
  // é¡µé¢çŠ¶æ€
  @State isLoading: boolean = false;
  


  /**
   * é¡µé¢åˆå§‹åŒ–
   */
  async aboutToAppear() {
    await this.loadSettings();
    await this.loadAppInfo();
  }

  /**
   * åŠ è½½è®¾ç½®ä¿¡æ¯
   */
  async loadSettings() {
    try {
      const dataPreferences = await preferences.getPreferences(getContext(), 'app_settings');
      
      this.autoBackup = await dataPreferences.get('auto_backup', true) as boolean;
      this.notificationEnabled = await dataPreferences.get('notification_enabled', true) as boolean;
    } catch (error) {
      console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
  }

  /**
   * åŠ è½½åº”ç”¨ä¿¡æ¯
   */
  async loadAppInfo() {
    try {
      const bundleInfo = await bundleManager.getBundleInfoForSelf(bundleManager.BundleFlag.GET_BUNDLE_INFO_DEFAULT);
      this.appVersion = bundleInfo.versionName || '1.0.0';
    } catch (error) {
      console.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥:', error);
    }
  }



  /**
   * ä¿å­˜è®¾ç½®
   */
  async saveSetting(key: string, value: string | number | boolean) {
    try {
      const dataPreferences = await preferences.getPreferences(getContext(), 'app_settings');
      await dataPreferences.put(key, value);
      await dataPreferences.flush();
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
      const saveErrorToast: ShowToastOptions = {
        message: 'ä¿å­˜è®¾ç½®å¤±è´¥',
        duration: 2000
      };
      promptAction.showToast(saveErrorToast);
    }
  }



  /**
   * åˆ‡æ¢è‡ªåŠ¨å¤‡ä»½
   */
  async toggleAutoBackup(enabled: boolean) {
    this.autoBackup = enabled;
    await this.saveSetting('auto_backup', enabled);
    
    const backupToast: ShowToastOptions = {
      message: enabled ? 'å·²å¼€å¯è‡ªåŠ¨å¤‡ä»½' : 'å·²å…³é—­è‡ªåŠ¨å¤‡ä»½',
      duration: 2000
    };
    promptAction.showToast(backupToast);
  }

  /**
   * åˆ‡æ¢é€šçŸ¥
   */
  async toggleNotification(enabled: boolean) {
    this.notificationEnabled = enabled;
    await this.saveSetting('notification_enabled', enabled);
    
    const notificationToast: ShowToastOptions = {
      message: enabled ? 'å·²å¼€å¯é€šçŸ¥' : 'å·²å…³é—­é€šçŸ¥',
      duration: 2000
    };
    promptAction.showToast(notificationToast);
  }



  /**
   * æ£€æŸ¥æ›´æ–°
   */
  async checkUpdate() {
    this.isLoading = true;
    try {
      // TODO: å®ç°æ›´æ–°æ£€æŸ¥é€»è¾‘
      await new Promise<void>(resolve => setTimeout(resolve, 2000)); // æ¨¡æ‹Ÿæ£€æŸ¥è¿‡ç¨‹
      
      promptAction.showDialog({
        title: 'æ£€æŸ¥æ›´æ–°',
        message: 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬',
        buttons: [{ text: 'çŸ¥é“äº†', color: '#007AFF' }] as DialogButton[]
      });
    } catch (error) {
      console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
      const updateErrorToast: ShowToastOptions = {
        message: 'æ£€æŸ¥æ›´æ–°å¤±è´¥',
        duration: 2000
      };
      promptAction.showToast(updateErrorToast);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ˜¾ç¤ºå…³äºä¿¡æ¯
   */
  showAbout() {
    promptAction.showDialog({
      title: 'å…³äºè¯­å½•å£çº¸',
      message: `ç‰ˆæœ¬ï¼š${this.appVersion}\n\nè¯­å½•å£çº¸æ˜¯ä¸€æ¬¾ç®€æ´ä¼˜é›…çš„è¯­å½•ç®¡ç†å’Œå£çº¸ç”Ÿæˆåº”ç”¨ã€‚\n\nâ€¢ æ”¶é›†å’Œç®¡ç†æ‚¨å–œçˆ±çš„è¯­å½•\nâ€¢ ç”Ÿæˆç²¾ç¾çš„è¯­å½•å£çº¸\nâ€¢ æ”¯æŒæ•°æ®å¯¼å…¥å¯¼å‡º\nâ€¢ å¤šç§ä¸ªæ€§åŒ–è®¾ç½®\n\næ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ï¼`,
      buttons: [{ text: 'çŸ¥é“äº†', color: '#007AFF' }] as DialogButton[]
    });
  }

  /**
   * æ˜¾ç¤ºéšç§æ”¿ç­–
   */
  showPrivacyPolicy() {
    promptAction.showDialog({
      title: 'éšç§æ”¿ç­–',
      message: 'æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ä¿æŠ¤ï¼š\n\nâ€¢ æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°è®¾å¤‡\nâ€¢ ä¸ä¼šæ”¶é›†æˆ–ä¸Šä¼ ä¸ªäººä¿¡æ¯\nâ€¢ ä¸ä¼šè®¿é—®æ‚¨çš„å…¶ä»–åº”ç”¨æ•°æ®\nâ€¢ å¯¼å‡ºåŠŸèƒ½ä»…åœ¨æ‚¨ä¸»åŠ¨æ“ä½œæ—¶æ‰§è¡Œ\n\nå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚',
      buttons: [{ text: 'çŸ¥é“äº†', color: '#007AFF' }] as DialogButton[]
    });
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack() {
    router.back();
  }

  /**
   * æ„å»ºé¡µé¢UI
   */
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#1D1D1F')
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())
        
        Text('è®¾ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1D1D1F')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ç¬¦ä¿æŒå±…ä¸­
        Text('')
          .width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#E5E5E5' })

      Scroll() {
          Column() {
            // åŠŸèƒ½è®¾ç½®
            Column() {
            Row() {
              Text('âš™ï¸')
                .fontSize(24)
                .margin({ right: 8 })
              
              Text('åŠŸèƒ½è®¾ç½®')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1D1D1F')
            }
            .width('100%')
            .margin({ bottom: 20 })

            // è‡ªåŠ¨å¤‡ä»½
            Row() {
              Row() {
                Text('ğŸ’¾')
                  .fontSize(24)
                  .margin({ right: 16 })
                
                Column() {
                  Text('è‡ªåŠ¨å¤‡ä»½')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#1D1D1F')
                  
                  Text('å®šæœŸè‡ªåŠ¨å¤‡ä»½è¯­å½•æ•°æ®')
                    .fontSize(14)
                    .fontColor('#86868B')
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.autoBackup })
                .onChange((isOn: boolean) => {
                  this.toggleAutoBackup(isOn);
                })
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
            .border({ width: { bottom: 1 }, color: '#F2F2F7' })

            // é€šçŸ¥è®¾ç½®
            Row() {
              Row() {
                Text('ğŸ””')
                  .fontSize(24)
                  .margin({ right: 16 })
                
                Column() {
                  Text('æ¨é€é€šçŸ¥')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#1D1D1F')
                  
                  Text('æ¥æ”¶åº”ç”¨ç›¸å…³é€šçŸ¥')
                    .fontSize(14)
                    .fontColor('#86868B')
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.notificationEnabled })
                .onChange((isOn: boolean) => {
                  this.toggleNotification(isOn);
                })
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .margin({ bottom: 20 })
          .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.04)', offsetY: 2 })



          // å…³äºåº”ç”¨
          Column() {
            Row() {
              Text('ğŸ“±')
                .fontSize(24)
                .margin({ right: 8 })
              
              Text('å…³äºåº”ç”¨')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1D1D1F')
            }
            .width('100%')
            .margin({ bottom: 20 })

            // ç‰ˆæœ¬ä¿¡æ¯
            Row() {
              Row() {
                Text('â„¹ï¸')
                  .fontSize(24)
                  .margin({ right: 16 })
                
                Column() {
                  Text('ç‰ˆæœ¬ä¿¡æ¯')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#1D1D1F')
                  
                  Text(`v${this.appVersion}`)
                    .fontSize(14)
                    .fontColor('#86868B')
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Text('>')
                .fontSize(18)
                .fontColor('#C7C7CC')
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
            .border({ width: { bottom: 1 }, color: '#F2F2F7' })
            .onClick(() => this.showAbout())

            // æ£€æŸ¥æ›´æ–°
            Row() {
              Row() {
                Text('ğŸ”„')
                  .fontSize(24)
                  .margin({ right: 16 })
                
                Text('æ£€æŸ¥æ›´æ–°')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1D1D1F')
              }
              .layoutWeight(1)
              
              if (this.isLoading) {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color('#007AFF')
              } else {
                Text('>')
                  .fontSize(18)
                  .fontColor('#C7C7CC')
              }
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
            .border({ width: { bottom: 1 }, color: '#F2F2F7' })
            .onClick(() => {
              if (!this.isLoading) {
                this.checkUpdate();
              }
            })

            // éšç§æ”¿ç­–
            Row() {
              Row() {
                Text('ğŸ”’')
                  .fontSize(24)
                  .margin({ right: 16 })
                
                Text('éšç§æ”¿ç­–')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1D1D1F')
              }
              .layoutWeight(1)
              
              Text('>')
                .fontSize(18)
                .fontColor('#C7C7CC')
            }
            .width('100%')
            .padding({ top: 20, bottom: 20 })
            .onClick(() => this.showPrivacyPolicy())
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .margin({ bottom: 32 })
          .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.04)', offsetY: 2 })
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor('#F8F9FA')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}