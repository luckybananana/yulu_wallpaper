import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { bundleManager } from '@kit.AbilityKit';

/**
 * å­—ä½“å¤§å°é€‰é¡¹æŽ¥å£
 */
interface FontSizeOption {
  label: string;
  value: number;
}

/**
 * å¯¹è¯æ¡†æŒ‰é’®æŽ¥å£
 */
interface DialogButton {
  text: string;
  color: string;
}

/**
 * Toasté€‰é¡¹æŽ¥å£
 */
interface ShowToastOptions {
  message: string;
  duration?: number;
}

/**
 * è®¾ç½®é¡µé¢
 * åŸºäºŽsettings.htmlå®žçŽ°åº”ç”¨è®¾ç½®åŠŸèƒ½
 * åŒ…å«ä¸»é¢˜è®¾ç½®ã€å­—ä½“è®¾ç½®ã€æ•°æ®ç®¡ç†ã€å…³äºŽåº”ç”¨ç­‰åŠŸèƒ½
 */
@Entry
@Component
struct SettingsPage {
  // è®¾ç½®é¡¹çŠ¶æ€
  @State isDarkMode: boolean = false;
  @State fontSize: number = 16;
  @State autoBackup: boolean = true;
  @State notificationEnabled: boolean = true;
  @State cacheSize: string = '0 MB';
  @State appVersion: string = '1.0.0';
  
  // é¡µé¢çŠ¶æ€
  @State isLoading: boolean = false;
  
  // è®¾ç½®é€‰é¡¹
  private fontSizeOptions: FontSizeOption[] = [
    { label: 'å°', value: 14 },
    { label: 'ä¸­', value: 16 },
    { label: 'å¤§', value: 18 },
    { label: 'ç‰¹å¤§', value: 20 }
  ];

  /**
   * é¡µé¢åˆå§‹åŒ–
   */
  async aboutToAppear() {
    await this.loadSettings();
    await this.loadAppInfo();
  }

  /**
   * åŠ è½½è®¾ç½®ä¿¡æ¯
   */
  async loadSettings() {
    try {
      const dataPreferences = await preferences.getPreferences(getContext(), 'app_settings');
      
      this.isDarkMode = await dataPreferences.get('dark_mode', false) as boolean;
      this.fontSize = await dataPreferences.get('font_size', 16) as number;
      this.autoBackup = await dataPreferences.get('auto_backup', true) as boolean;
      this.notificationEnabled = await dataPreferences.get('notification_enabled', true) as boolean;
      
      // è®¡ç®—ç¼“å­˜å¤§å°
      await this.calculateCacheSize();
    } catch (error) {
      console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
    }
  }

  /**
   * åŠ è½½åº”ç”¨ä¿¡æ¯
   */
  async loadAppInfo() {
    try {
      const bundleInfo = await bundleManager.getBundleInfoForSelf(bundleManager.BundleFlag.GET_BUNDLE_INFO_DEFAULT);
      this.appVersion = bundleInfo.versionName || '1.0.0';
    } catch (error) {
      console.error('èŽ·å–åº”ç”¨ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  /**
   * è®¡ç®—ç¼“å­˜å¤§å°
   */
  async calculateCacheSize() {
    try {
      // TODO: å®žçŽ°ç¼“å­˜å¤§å°è®¡ç®—
      this.cacheSize = '2.5 MB';
    } catch (error) {
      console.error('è®¡ç®—ç¼“å­˜å¤§å°å¤±è´¥:', error);
      this.cacheSize = 'æœªçŸ¥';
    }
  }

  /**
   * ä¿å­˜è®¾ç½®
   */
  async saveSetting(key: string, value: string | number | boolean) {
    try {
      const dataPreferences = await preferences.getPreferences(getContext(), 'app_settings');
      await dataPreferences.put(key, value);
      await dataPreferences.flush();
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
      const saveErrorToast: ShowToastOptions = {
        message: 'ä¿å­˜è®¾ç½®å¤±è´¥',
        duration: 2000
      };
      promptAction.showToast(saveErrorToast);
    }
  }

  /**
   * åˆ‡æ¢æ·±è‰²æ¨¡å¼
   */
  async toggleDarkMode(enabled: boolean) {
    this.isDarkMode = enabled;
    await this.saveSetting('dark_mode', enabled);
    
    promptAction.showToast({
      message: enabled ? 'å·²å¼€å¯æ·±è‰²æ¨¡å¼' : 'å·²å…³é—­æ·±è‰²æ¨¡å¼',
      duration: 2000
    });
  }

  /**
   * è®¾ç½®å­—ä½“å¤§å°
   */
  async setFontSize(size: number) {
    this.fontSize = size;
    await this.saveSetting('font_size', size);
    
    promptAction.showToast({
      message: `å­—ä½“å¤§å°å·²è®¾ç½®ä¸º${size}px`,
      duration: 2000
    });
  }

  /**
   * åˆ‡æ¢è‡ªåŠ¨å¤‡ä»½
   */
  async toggleAutoBackup(enabled: boolean) {
    this.autoBackup = enabled;
    await this.saveSetting('auto_backup', enabled);
    
    const backupToast: ShowToastOptions = {
      message: enabled ? 'å·²å¼€å¯è‡ªåŠ¨å¤‡ä»½' : 'å·²å…³é—­è‡ªåŠ¨å¤‡ä»½',
      duration: 2000
    };
    promptAction.showToast(backupToast);
  }

  /**
   * åˆ‡æ¢é€šçŸ¥
   */
  async toggleNotification(enabled: boolean) {
    this.notificationEnabled = enabled;
    await this.saveSetting('notification_enabled', enabled);
    
    const notificationToast: ShowToastOptions = {
      message: enabled ? 'å·²å¼€å¯é€šçŸ¥' : 'å·²å…³é—­é€šçŸ¥',
      duration: 2000
    };
    promptAction.showToast(notificationToast);
  }

  /**
   * æ¸…é™¤ç¼“å­˜
   */
  async clearCache() {
    promptAction.showDialog({
      title: 'æ¸…é™¤ç¼“å­˜',
      message: 'ç¡®å®šè¦æ¸…é™¤åº”ç”¨ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œå›¾ç‰‡ç¼“å­˜ã€‚',
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: '#666666'
        },
        {
          text: 'æ¸…é™¤',
          color: '#FF3B30'
        }
      ] as DialogButton[]
    }).then(async (result) => {
      if (result.index === 1) {
        this.isLoading = true;
        try {
          // TODO: å®žçŽ°ç¼“å­˜æ¸…é™¤é€»è¾‘
          await new Promise<void>(resolve => setTimeout(resolve, 1000)); // æ¨¡æ‹Ÿæ¸…é™¤è¿‡ç¨‹
          
          this.cacheSize = '0 MB';
          const clearSuccessToast: ShowToastOptions = {
            message: 'ç¼“å­˜å·²æ¸…é™¤',
            duration: 2000
          };
          promptAction.showToast(clearSuccessToast);
        } catch (error) {
          console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
          const clearErrorToast: ShowToastOptions = {
            message: 'æ¸…é™¤ç¼“å­˜å¤±è´¥',
            duration: 2000
          };
          promptAction.showToast(clearErrorToast);
        } finally {
          this.isLoading = false;
        }
      }
    });
  }

  /**
   * æ£€æŸ¥æ›´æ–°
   */
  async checkUpdate() {
    this.isLoading = true;
    try {
      // TODO: å®žçŽ°æ›´æ–°æ£€æŸ¥é€»è¾‘
      await new Promise<void>(resolve => setTimeout(resolve, 2000)); // æ¨¡æ‹Ÿæ£€æŸ¥è¿‡ç¨‹
      
      promptAction.showDialog({
        title: 'æ£€æŸ¥æ›´æ–°',
        message: 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬',
        buttons: [{ text: 'çŸ¥é“äº†', color: '#007AFF' }] as DialogButton[]
      });
    } catch (error) {
      console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
      const updateErrorToast: ShowToastOptions = {
        message: 'æ£€æŸ¥æ›´æ–°å¤±è´¥',
        duration: 2000
      };
      promptAction.showToast(updateErrorToast);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ˜¾ç¤ºå…³äºŽä¿¡æ¯
   */
  showAbout() {
    promptAction.showDialog({
      title: 'å…³äºŽè¯­å½•å£çº¸',
      message: `ç‰ˆæœ¬ï¼š${this.appVersion}\n\nè¯­å½•å£çº¸æ˜¯ä¸€æ¬¾ç®€æ´ä¼˜é›…çš„è¯­å½•ç®¡ç†å’Œå£çº¸ç”Ÿæˆåº”ç”¨ã€‚\n\nâ€¢ æ”¶é›†å’Œç®¡ç†æ‚¨å–œçˆ±çš„è¯­å½•\nâ€¢ ç”Ÿæˆç²¾ç¾Žçš„è¯­å½•å£çº¸\nâ€¢ æ”¯æŒæ•°æ®å¯¼å…¥å¯¼å‡º\nâ€¢ å¤šç§ä¸ªæ€§åŒ–è®¾ç½®\n\næ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ï¼`,
      buttons: [{ text: 'çŸ¥é“äº†', color: '#007AFF' }] as DialogButton[]
    });
  }

  /**
   * æ˜¾ç¤ºéšç§æ”¿ç­–
   */
  showPrivacyPolicy() {
    promptAction.showDialog({
      title: 'éšç§æ”¿ç­–',
      message: 'æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ä¿æŠ¤ï¼š\n\nâ€¢ æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°è®¾å¤‡\nâ€¢ ä¸ä¼šæ”¶é›†æˆ–ä¸Šä¼ ä¸ªäººä¿¡æ¯\nâ€¢ ä¸ä¼šè®¿é—®æ‚¨çš„å…¶ä»–åº”ç”¨æ•°æ®\nâ€¢ å¯¼å‡ºåŠŸèƒ½ä»…åœ¨æ‚¨ä¸»åŠ¨æ“ä½œæ—¶æ‰§è¡Œ\n\nå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚',
      buttons: [{ text: 'çŸ¥é“äº†', color: '#007AFF' }] as DialogButton[]
    });
  }

  /**
   * è¿”å›žä¸Šä¸€é¡µ
   */
  goBack() {
    router.back();
  }

  /**
   * æž„å»ºé¡µé¢UI
   */
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333333')
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())
        
        Text('è®¾ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ç¬¦ä¿æŒå±…ä¸­
        Text('')
          .width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#E5E5E5' })

      Scroll() {
        Column() {
          // å¤–è§‚è®¾ç½®
          Column() {
            Text('å¤–è§‚è®¾ç½®')
              .fontSize(14)
              .fontColor('#666666')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            // æ·±è‰²æ¨¡å¼
            Row() {
              Row() {
                Text('ðŸŒ™')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text('æ·±è‰²æ¨¡å¼')
                    .fontSize(16)
                    .fontColor('#333333')
                  
                  Text('å¼€å¯åŽç•Œé¢å°†ä½¿ç”¨æ·±è‰²ä¸»é¢˜')
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.isDarkMode })
                .onChange((isOn: boolean) => {
                  this.toggleDarkMode(isOn);
                })
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .border({ width: { bottom: 1 }, color: '#F0F0F0' })

            // å­—ä½“å¤§å°
            Row() {
              Row() {
                Text('ðŸ”¤')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text('å­—ä½“å¤§å°')
                    .fontSize(16)
                    .fontColor('#333333')
                  
                  Text(`å½“å‰ï¼š${this.fontSize}px`)
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Text('>')
                .fontSize(16)
                .fontColor('#CCCCCC')
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .onClick(() => {
              // ä½¿ç”¨ç®€å•çš„å¾ªçŽ¯åˆ‡æ¢å­—ä½“å¤§å°
              const currentIndex = this.fontSizeOptions.findIndex(option => option.value === this.fontSize);
              const nextIndex = (currentIndex + 1) % this.fontSizeOptions.length;
              this.setFontSize(this.fontSizeOptions[nextIndex].value);
            })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })

          // åŠŸèƒ½è®¾ç½®
          Column() {
            Text('åŠŸèƒ½è®¾ç½®')
              .fontSize(14)
              .fontColor('#666666')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            // è‡ªåŠ¨å¤‡ä»½
            Row() {
              Row() {
                Text('ðŸ’¾')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text('è‡ªåŠ¨å¤‡ä»½')
                    .fontSize(16)
                    .fontColor('#333333')
                  
                  Text('å®šæœŸè‡ªåŠ¨å¤‡ä»½è¯­å½•æ•°æ®')
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.autoBackup })
                .onChange((isOn: boolean) => {
                  this.toggleAutoBackup(isOn);
                })
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .border({ width: { bottom: 1 }, color: '#F0F0F0' })

            // é€šçŸ¥è®¾ç½®
            Row() {
              Row() {
                Text('ðŸ””')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text('æŽ¨é€é€šçŸ¥')
                    .fontSize(16)
                    .fontColor('#333333')
                  
                  Text('æŽ¥æ”¶åº”ç”¨ç›¸å…³é€šçŸ¥')
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Toggle({ type: ToggleType.Switch, isOn: this.notificationEnabled })
                .onChange((isOn: boolean) => {
                  this.toggleNotification(isOn);
                })
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })

          // å­˜å‚¨ç®¡ç†
          Column() {
            Text('å­˜å‚¨ç®¡ç†')
              .fontSize(14)
              .fontColor('#666666')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            // ç¼“å­˜å¤§å°
            Row() {
              Row() {
                Text('ðŸ“')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text('ç¼“å­˜å¤§å°')
                    .fontSize(16)
                    .fontColor('#333333')
                  
                  Text(this.cacheSize)
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Button('æ¸…é™¤')
                .height(32)
                .fontSize(14)
                .fontColor('#FF3B30')
                .backgroundColor('#FFF0F0')
                .borderRadius(6)
                .enabled(!this.isLoading)
                .onClick(() => this.clearCache())
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 16 })

          // å…³äºŽåº”ç”¨
          Column() {
            Text('å…³äºŽåº”ç”¨')
              .fontSize(14)
              .fontColor('#666666')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            // ç‰ˆæœ¬ä¿¡æ¯
            Row() {
              Row() {
                Text('â„¹ï¸')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text('ç‰ˆæœ¬ä¿¡æ¯')
                    .fontSize(16)
                    .fontColor('#333333')
                  
                  Text(`v${this.appVersion}`)
                    .fontSize(12)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
              }
              .layoutWeight(1)
              
              Text('>')
                .fontSize(16)
                .fontColor('#CCCCCC')
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .border({ width: { bottom: 1 }, color: '#F0F0F0' })
            .onClick(() => this.showAbout())

            // æ£€æŸ¥æ›´æ–°
            Row() {
              Row() {
                Text('ðŸ”„')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Text('æ£€æŸ¥æ›´æ–°')
                  .fontSize(16)
                  .fontColor('#333333')
              }
              .layoutWeight(1)
              
              if (this.isLoading) {
                LoadingProgress()
                  .width(20)
                  .height(20)
                  .color('#007AFF')
              } else {
                Text('>')
                  .fontSize(16)
                  .fontColor('#CCCCCC')
              }
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .border({ width: { bottom: 1 }, color: '#F0F0F0' })
            .onClick(() => {
              if (!this.isLoading) {
                this.checkUpdate();
              }
            })

            // éšç§æ”¿ç­–
            Row() {
              Row() {
                Text('ðŸ”’')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Text('éšç§æ”¿ç­–')
                  .fontSize(16)
                  .fontColor('#333333')
              }
              .layoutWeight(1)
              
              Text('>')
                .fontSize(16)
                .fontColor('#CCCCCC')
            }
            .width('100%')
            .padding({ top: 16, bottom: 16 })
            .onClick(() => this.showPrivacyPolicy())
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 32 })
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}